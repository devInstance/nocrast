
@inject TasksService Service;
@inject ITimeProvider TimeProvider;
@inject ILogProvider LogProvider;

@using NoCrast.Client.ModelExtensions;

<li>
    <div class="alert alert-info timer-item-container" role="document">
        <div class="timer-item-context">
            <button class="btn btn-default timer-button" @onclick="@(() => Remove())">
                <span class="oi oi-x" aria-hidden="true"></span>
            </button>
        </div>
        <div class="timer-item-title left-column">
            @if (!IsEditing)
            {
                <span class="timer-text">
                    <strong>@Item.Task.Title</strong>
                    <button class="btn btn-default timer-button" @onclick="@(() => StartEditing())">
                        <span class="oi oi-pencil small-timer-button" aria-hidden="true"></span>
                    </button>
                </span>
            }
            else
            {
                <EditForm Model="@Item" OnValidSubmit="@(() => ApplyChanges())" @onreset="@(()=>ResetChanges())">
                    <InputText @bind-Value="@Item.Task.Title"></InputText>
                    <button type="submit" class="btn timer-button text-info">
                        <span class="oi oi-circle-check" aria-hidden="true"></span>
                    </button>
                    <button class="btn timer-button text-danger">
                        <span class="oi oi-circle-x" aria-hidden="true"></span>
                    </button>
                </EditForm>
            }
        </div>
        <div class="timer-item-time left-column">
            <span class="timer-text">@String.Format("{0:F1}", Item.TotalHoursSpent) hour(s)</span>
        </div>
        <div class="timer-item-panel">
            <button class="btn btn-default timer-button" @onclick="@(() => Start())">
                <span class="oi oi-media-play" aria-hidden="true"></span>
            </button>
        </div>
        <TimeLogPanelView Item="Item"></TimeLogPanelView>
    </div>
</li>

@code {
    [Parameter]
    public TaskItemView Item { get; set; }

    private bool IsEditing { get; set; }

    private ILog log;

    protected override void OnInitialized()
    {
        IsEditing = false;
        log = LogProvider.CreateLogger(this);
    }

    private async void Remove()
    {
        await Service.RemoveTaskAsync(Item);
    }

    private void Start()
    {
        Service.StartTaskAsync(Item);
    }

    private void StartEditing()
    {
        IsEditing = true;
    }

    private void ApplyChanges()
    {
        IsEditing = false;
        log.D("ApplyChanges");
    }

    private void ResetChanges()
    {
        IsEditing = false;
        log.D("ResetChanges");
    }
}
