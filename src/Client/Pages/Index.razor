@page "/"

@using NoCrast.Shared.Model;
@using NoCrast.Client.ModelExtensions;
@using NoCrast.Client.Services;
@using NoCrast.Client.Utils;

@using System.Timers;

@inject TimersService Service;
@inject ITimeProvider TimeProvider;

<input class="new-timer-edit" @bind="Title" type="text" />

<button class="btn btn-primary" @onclick="AddTimer">Add Timer</button>

@if (TasksList != null)
{
    <ul class="timer-list">
        @foreach (var item in TasksList)
        {
            <li>
                <div class="alert alert-info timer-item-container" role="document">
                    <div class="timer-item-context">
                        <button class="btn btn-default timer-button" @onclick="@(() => Remove(item))">
                            <span class="oi oi-circle-x" aria-hidden="true"></span>
                        </button>
                    </div>
                    <div class="timer-item-title">
                        <span class="timer-text">
                            <strong>@item.Title</strong>
                        </span>
                    </div>
                    <div class="timer-item-time">
                        <span class="timer-text">@FormatTime(item.GetElapsedTimeSpan(TimeProvider))</span>
                    </div>
                    <div class="timer-item-panel">
                        @if (item.IsRunning)
                        {
                            <button class="btn btn-default timer-button" @onclick="@(() => Stop(item))">
                                <span class="oi oi-media-pause" aria-hidden="true"></span>
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-default timer-button" @onclick="@(() => Start(item))">
                                <span class="oi oi-media-play" aria-hidden="true"></span>
                            </button>
                        }
                    </div>
                </div>
            </li>
        }
    </ul>
}

@code {

    private List<TaskItem> TasksList { get; set; }

    private string Title = "";

    private System.Timers.Timer timer;

    private string FormatTime(TimeSpan time)
    {
        return String.Format("{0:hh}:{0:mm}:{0:ss}", time);
    }

    protected override void OnInitialized()
    {
        try
        {
            SetUpTimer();

            Service.DataHasChanged += OnDataHasChanged;

            RefreshData();
        }
        catch (Exception ex)
        {
            //TODO: do something
        }
    }

    private void SetUpTimer()
    {
        timer = new System.Timers.Timer(1000.0);
        timer.Elapsed += OnTimedEvent;
        timer.AutoReset = true;
        timer.Enabled = true;
    }

    private void OnDataHasChanged(Object sender, EventArgs e)
    {
        RefreshData();
    }

    private void RefreshData()
    {
        TasksList = Service.GetTasks();
        StateHasChanged();
    }

    private void OnTimedEvent(Object source, ElapsedEventArgs e)
    {
        StateHasChanged();
    }

    private void AddTimer()
    {
        Service.AddNewTask(Title);
    }

    private void Remove(TaskItem item)
    {
        Service.RemoveTask(item);
    }

    private void Start(TaskItem item)
    {
        Service.StartTask(item);
    }

    private void Stop(TaskItem item)
    {
        Service.StopTask(item);
    }

}
